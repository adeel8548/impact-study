/**
 * TEACHER CHAT PAGE - Complete Implementation
 * 
 * Copy this entire file to: app/teacher/chat/page.tsx
 * 
 * Features:
 * - Load all conversations with admins from Firebase in real-time
 * - Display admin names from Firebase users collection
 * - Show last message preview for each conversation
 * - Real-time message updates via Firestore onSnapshot
 * - Mark messages as read when conversation is opened
 * - Send and receive messages in real-time
 */

"use client";

import React, { useEffect, useMemo, useState } from \"react\";\nimport { createClient } from \"@/lib/supabase/client\";\nimport { ChatWindow } from \"@/components/chat/ChatWindow\";\nimport { TeacherHeader } from \"@/components/teacher-header\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Loader2, MessageSquare } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { cn } from \"@/lib/utils\";\nimport {\n  subscribeToTeacherConversations,\n  getOrCreateConversation,\n  Conversation,\n} from \"@/lib/firestore-helpers\";\n\ninterface ConversationView extends Conversation {\n  adminName?: string;\n}\n\nexport default function TeacherChatPage() {\n  const supabase = useMemo(() => createClient(), []);\n\n  const [currentUserId, setCurrentUserId] = useState<string>(\"\");\n  const [currentUserName, setCurrentUserName] = useState<string>(\"\");\n  const [conversations, setConversations] = useState<ConversationView[]>([]);\n  const [selectedConversationId, setSelectedConversationId] = useState<string>(\"\");\n  const [selectedConversation, setSelectedConversation] = useState<ConversationView | null>(null);\n  const [isLoadingConversations, setIsLoadingConversations] = useState(false);\n\n  // Get current teacher user\n  useEffect(() => {\n    const getUser = async () => {\n      try {\n        const {\n          data: { user },\n        } = await supabase.auth.getUser();\n        if (user) {\n          setCurrentUserId(user.id);\n          const { data: profile } = await supabase\n            .from(\"profiles\")\n            .select(\"name\")\n            .eq(\"id\", user.id)\n            .single();\n          setCurrentUserName(profile?.name || user.email || \"Teacher\");\n        }\n      } catch (err) {\n        console.error(\"Error loading user:\", err);\n      }\n    };\n    getUser();\n  }, [supabase]);\n\n  // Subscribe to conversations in real-time from Firebase\n  useEffect(() => {\n    if (!currentUserId) return;\n\n    setIsLoadingConversations(true);\n    const unsubscribe = subscribeToTeacherConversations(currentUserId, async (convs) => {\n      // Load admin names for each conversation\n      const adminIds = [...new Set(convs.map((c) => c.adminId))];\n      \n      // Get admin names from Supabase (fallback since they're not in Firebase users yet)\n      const { data: admins } = await supabase\n        .from(\"profiles\")\n        .select(\"id, name\")\n        .in(\"id\", adminIds);\n      \n      const adminMap = Object.fromEntries((admins || []).map((a: any) => [a.id, a.name]));\n      \n      // Enrich conversations with admin names\n      const enrichedConvs = convs.map((conv) => ({\n        ...conv,\n        adminName: adminMap[conv.adminId] || \"Admin\",\n      }));\n      \n      setConversations(enrichedConvs);\n      setIsLoadingConversations(false);\n      \n      // Auto-select first conversation if none selected\n      if (enrichedConvs.length > 0 && !selectedConversationId) {\n        setSelectedConversationId(enrichedConvs[0].id);\n        setSelectedConversation(enrichedConvs[0]);\n      }\n    });\n\n    return () => unsubscribe();\n  }, [currentUserId, supabase, selectedConversationId]);\n\n  // Open conversation and load admin details\n  const openConversation = (conversation: ConversationView) => {\n    setSelectedConversationId(conversation.id);\n    setSelectedConversation(conversation);\n  };\n\n  // Create new conversation with admin\n  const createConversationWithAdmin = async () => {\n    try {\n      // Get first admin from Supabase\n      const { data: adminUsers, error: adminError } = await supabase\n        .from(\"profiles\")\n        .select(\"id\")\n        .eq(\"role\", \"admin\")\n        .limit(1);\n\n      if (adminError || !adminUsers || adminUsers.length === 0) {\n        toast.error(\"No admin found\");\n        return;\n      }\n\n      const adminId = adminUsers[0].id;\n      const convId = await getOrCreateConversation(adminId, currentUserId);\n      setSelectedConversationId(convId);\n    } catch (error) {\n      console.error(\"Error creating conversation:\", error);\n      toast.error(\"Failed to create conversation\");\n    }\n  };\n\n  // Loading state\n  if (!currentUserId) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <TeacherHeader />\n        <main className=\"px-4 md:px-6 py-4 md:py-6 flex items-center justify-center\">\n          <Loader2 className=\"w-6 h-6 animate-spin\" />\n        </main>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <TeacherHeader />\n      <main className=\"px-4 md:px-6 py-4 md:py-6 space-y-4\">\n        {/* Header */}\n        <div className=\"flex items-center gap-3\">\n          <MessageSquare className=\"w-5 h-5\" />\n          <div>\n            <h1 className=\"text-2xl font-semibold\">Messages</h1>\n            <p className=\"text-sm text-muted-foreground\">\n              Chat with admin in real time\n            </p>\n          </div>\n        </div>\n\n        {/* Main Layout: Conversations List | Chat Window */}\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          {/* LEFT: Conversations List */}\n          <Card className=\"p-4 space-y-3 h-[600px] overflow-y-auto\">\n            <div>\n              <Button\n                onClick={createConversationWithAdmin}\n                className=\"w-full mb-3\"\n              >\n                Start Chat with Admin\n              </Button>\n            </div>\n\n            {isLoadingConversations ? (\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                <Loader2 className=\"w-4 h-4 animate-spin\" /> Loading chats...\n              </div>\n            ) : conversations.length === 0 ? (\n              <p className=\"text-sm text-muted-foreground\">\n                No chats yet. Click the button above to start.\n              </p>\n            ) : (\n              <div className=\"space-y-2\">\n                {conversations.map((conv) => {\n                  const isActive = selectedConversationId === conv.id;\n                  const adminName = conv.adminName || \"Admin\";\n                  return (\n                    <button\n                      key={conv.id}\n                      onClick={() => openConversation(conv)}\n                      className={cn(\n                        \"w-full text-left p-3 rounded border transition-colors\",\n                        isActive\n                          ? \"bg-primary/10 border-primary\"\n                          : \"bg-background hover:bg-muted\"\n                      )}\n                    >\n                      <div className=\"font-semibold text-foreground text-sm\">\n                        {adminName}\n                      </div>\n                      <div className=\"text-xs text-muted-foreground line-clamp-1\">\n                        {conv.lastMessage || \"No messages\"}\n                      </div>\n                    </button>\n                  );\n                })}\n              </div>\n            )}\n          </Card>\n\n          {/* RIGHT: Chat Window */}\n          <Card className=\"p-4 md:col-span-2 h-[600px] overflow-hidden\">\n            {selectedConversationId && selectedConversation ? (\n              <ChatWindow\n                conversationId={selectedConversationId}\n                currentUserId={currentUserId}\n                currentUserName={currentUserName}\n              />\n            ) : (\n              <div className=\"h-full flex flex-col items-center justify-center text-muted-foreground\">\n                <MessageSquare className=\"w-12 h-12 mb-2 opacity-50\" />\n                <p>Select or create a chat to start messaging</p>\n              </div>\n            )}\n          </Card>\n        </div>\n      </main>\n    </div>\n  );\n}
