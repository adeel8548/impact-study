/**
 * ADMIN CHAT PAGE - Complete Implementation
 * 
 * Copy this entire file to: app/admin/chat/page.tsx
 * 
 * Features:
 * - Load all teachers from Supabase
 * - Display conversations from Firebase with real-time updates
 * - Multi-select teachers for broadcast
 * - Send broadcast message to multiple teachers
 * - Real-time chat with individual teachers
 * - Show teacher names from Firebase users collection
 */

"use client";

import React, { useEffect, useMemo, useState } from "react";
import { createClient } from "@/lib/supabase/client";
import { ChatWindow } from "@/components/chat/ChatWindow";
import { AdminSidebar } from "@/components/admin-sidebar";
import { Card } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { Loader2, MessageSquare, Send } from "lucide-react";
import { toast } from "sonner";
import { cn } from "@/lib/utils";
import {\n  subscribeToAdminConversations,\n  getOrCreateConversation,\n  broadcastMessage,\n  Conversation,\n} from \"@/lib/firestore-helpers\";\n\ninterface TeacherProfile {\n  id: string;\n  name: string;\n  email?: string;\n}\n\nexport default function AdminChatPage() {\n  const supabase = useMemo(() => createClient(), []);\n\n  const [currentUserId, setCurrentUserId] = useState<string>(\"\");\n  const [currentUserName, setCurrentUserName] = useState<string>(\"\");\n  const [conversations, setConversations] = useState<Conversation[]>([]);\n  const [teachers, setTeachers] = useState<TeacherProfile[]>([]);\n  const [selectedConversationId, setSelectedConversationId] = useState<string>(\"\");\n  const [selectedTeacherIds, setSelectedTeacherIds] = useState<Set<string>>(new Set());\n  const [broadcastText, setBroadcastText] = useState(\"\");\n  const [isLoadingTeachers, setIsLoadingTeachers] = useState(false);\n  const [isLoadingConversations, setIsLoadingConversations] = useState(false);\n  const [isSendingBroadcast, setIsSendingBroadcast] = useState(false);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n\n  // Get current admin user\n  useEffect(() => {\n    const getUser = async () => {\n      try {\n        const {\n          data: { user },\n        } = await supabase.auth.getUser();\n        if (user) {\n          setCurrentUserId(user.id);\n          const { data: profile } = await supabase\n            .from(\"profiles\")\n            .select(\"name\")\n            .eq(\"id\", user.id)\n            .single();\n          setCurrentUserName(profile?.name || user.email || \"Admin\");\n        }\n      } catch (err) {\n        console.error(\"Error loading user:\", err);\n      }\n    };\n    getUser();\n  }, [supabase]);\n\n  // Load all teachers from Supabase\n  useEffect(() => {\n    const loadTeachers = async () => {\n      setIsLoadingTeachers(true);\n      try {\n        const { data, error } = await supabase\n          .from(\"profiles\")\n          .select(\"id, name, email\")\n          .eq(\"role\", \"teacher\");\n\n        if (!error && data) {\n          setTeachers(\n            data.map((t: any) => ({\n              id: t.id,\n              name: t.name,\n              email: t.email,\n            }))\n          );\n        } else {\n          console.error(\"Error loading teachers:\", error);\n        }\n      } catch (err) {\n        console.error(\"Exception loading teachers:\", err);\n      } finally {\n        setIsLoadingTeachers(false);\n      }\n    };\n\n    loadTeachers();\n  }, [supabase]);\n\n  // Subscribe to conversations in real-time from Firebase\n  useEffect(() => {\n    if (!currentUserId) return;\n\n    setIsLoadingConversations(true);\n    const unsubscribe = subscribeToAdminConversations(currentUserId, async (convs) => {\n      // Enrich conversations with teacher names from the teachers list\n      const enrichedConvs = await Promise.all(\n        convs.map(async (conv) => {\n          const teacher = teachers.find((t) => t.id === conv.teacherId);\n          return { ...conv, teacherName: teacher?.name, teacherEmail: teacher?.email };\n        })\n      );\n      setConversations(enrichedConvs as any);\n      setIsLoadingConversations(false);\n    });\n\n    return () => unsubscribe();\n  }, [currentUserId, teachers]);\n\n  // Toggle teacher selection for broadcast\n  const toggleTeacher = (teacherId: string) => {\n    const newSelected = new Set(selectedTeacherIds);\n    if (newSelected.has(teacherId)) {\n      newSelected.delete(teacherId);\n    } else {\n      newSelected.add(teacherId);\n    }\n    setSelectedTeacherIds(newSelected);\n  };\n\n  // Open conversation with a teacher\n  const openConversation = async (teacherId: string) => {\n    try {\n      const convId = await getOrCreateConversation(currentUserId, teacherId);\n      setSelectedConversationId(convId);\n    } catch (error) {\n      console.error(\"Error opening conversation:\", error);\n      toast.error(\"Failed to open conversation\");\n    }\n  };\n\n  // Send broadcast message to all selected teachers\n  const handleSendBroadcast = async () => {\n    if (!broadcastText.trim()) {\n      toast.error(\"Please enter a message\");\n      return;\n    }\n\n    if (selectedTeacherIds.size === 0) {\n      toast.error(\"Please select at least one teacher\");\n      return;\n    }\n\n    setIsSendingBroadcast(true);\n    try {\n      // Send the same message to all selected teachers\n      await broadcastMessage(\n        currentUserId,\n        Array.from(selectedTeacherIds),\n        broadcastText.trim()\n      );\n      \n      setBroadcastText(\"\");\n      setSelectedTeacherIds(new Set());\n      toast.success(`Message sent to ${selectedTeacherIds.size} teacher(s)`);\n    } catch (error) {\n      console.error(\"Error sending broadcast:\", error);\n      toast.error(\"Failed to send broadcast message\");\n    } finally {\n      setIsSendingBroadcast(false);\n    }\n  };\n\n  // Filter teachers by search term\n  const filteredTeachers = useMemo(() => {\n    if (!searchTerm.trim()) return teachers;\n    const term = searchTerm.toLowerCase();\n    return teachers.filter(\n      (t) =>\n        t.name?.toLowerCase().includes(term) ||\n        t.email?.toLowerCase().includes(term)\n    );\n  }, [teachers, searchTerm]);\n\n  // Loading state\n  if (!currentUserId) {\n    return (\n      <div className=\"flex min-h-screen\">\n        <AdminSidebar />\n        <main className=\"flex-1 ml-0 md:ml-64 p-4 md:p-6 flex items-center justify-center\">\n          <Loader2 className=\"w-6 h-6 animate-spin\" />\n        </main>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex min-h-screen\">\n      <AdminSidebar />\n      <main className=\"flex-1 ml-0 md:ml-64 p-4 md:p-6 space-y-4\">\n        {/* Header */}\n        <div className=\"flex items-center gap-3\">\n          <MessageSquare className=\"w-5 h-5\" />\n          <div>\n            <h1 className=\"text-2xl font-semibold\">Chat</h1>\n            <p className=\"text-sm text-muted-foreground\">\n              Manage conversations with teachers and send broadcast messages\n            </p>\n          </div>\n        </div>\n\n        {/* Main Layout: Teachers List | Broadcast | Conversations | Chat */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-4\">\n          {/* LEFT: Teachers List & Broadcast Panel */}\n          <Card className=\"lg:col-span-1 p-4 space-y-4 overflow-y-auto max-h-[700px]\">\n            {/* Teachers List */}\n            <div>\n              <h2 className=\"font-semibold mb-3\">Teachers</h2>\n              <Input\n                placeholder=\"Search teachers...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"mb-3\"\n              />\n            </div>\n\n            {isLoadingTeachers ? (\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                <Loader2 className=\"w-4 h-4 animate-spin\" /> Loading teachers...\n              </div>\n            ) : (\n              <div className=\"space-y-2\">\n                {filteredTeachers.map((teacher) => (\n                  <button\n                    key={teacher.id}\n                    onClick={() => toggleTeacher(teacher.id)}\n                    className={cn(\n                      \"w-full text-left p-2 rounded border transition-colors flex items-center gap-2\",\n                      selectedTeacherIds.has(teacher.id)\n                        ? \"bg-primary/10 border-primary\"\n                        : \"bg-background hover:bg-muted\"\n                    )}\n                  >\n                    <Checkbox checked={selectedTeacherIds.has(teacher.id)} readOnly />\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"text-sm font-medium truncate\">{teacher.name}</div>\n                      <div className=\"text-xs text-muted-foreground truncate\">\n                        {teacher.email}\n                      </div>\n                    </div>\n                  </button>\n                ))}\n              </div>\n            )}\n\n            {/* Broadcast Section */}\n            <div className=\"border-t pt-4 space-y-2\">\n              <h3 className=\"font-semibold text-sm\">\n                Broadcast ({selectedTeacherIds.size})\n              </h3>\n              <div className=\"space-y-2\">\n                <textarea\n                  placeholder=\"Type broadcast message...\"\n                  value={broadcastText}\n                  onChange={(e) => setBroadcastText(e.target.value)}\n                  className=\"w-full p-2 border rounded text-sm resize-none focus:outline-none focus:ring-2 focus:ring-primary\"\n                  rows={3}\n                />\n                <Button\n                  onClick={handleSendBroadcast}\n                  disabled={isSendingBroadcast || selectedTeacherIds.size === 0}\n                  className=\"w-full\"\n                  size=\"sm\"\n                >\n                  {isSendingBroadcast ? (\n                    <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />\n                  ) : (\n                    <Send className=\"w-4 h-4 mr-2\" />\n                  )}\n                  Send to {selectedTeacherIds.size}\n                </Button>\n              </div>\n            </div>\n          </Card>\n\n          {/* CENTER: Conversations List */}\n          <Card className=\"lg:col-span-1 p-4 max-h-[700px] overflow-y-auto\">\n            <h2 className=\"font-semibold mb-3\">Conversations</h2>\n            {isLoadingConversations ? (\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                <Loader2 className=\"w-4 h-4 animate-spin\" /> Loading...\n              </div>\n            ) : conversations.length === 0 ? (\n              <p className=\"text-sm text-muted-foreground\">\n                No conversations yet. Select teachers above and send a broadcast message.\n              </p>\n            ) : (\n              <div className=\"space-y-2\">\n                {conversations.map((conv) => {\n                  const isActive = selectedConversationId === conv.id;\n                  const teacherName = (conv as any).teacherName || \"Teacher\";\n                  return (\n                    <button\n                      key={conv.id}\n                      onClick={() => openConversation(conv.teacherId)}\n                      className={cn(\n                        \"w-full text-left p-3 rounded border transition-colors\",\n                        isActive\n                          ? \"bg-primary/10 border-primary\"\n                          : \"bg-background hover:bg-muted\"\n                      )}\n                    >\n                      <div className=\"font-semibold text-sm\">{teacherName}</div>\n                      <div className=\"text-xs text-muted-foreground line-clamp-1\">\n                        {conv.lastMessage || \"No messages yet\"}\n                      </div>\n                    </button>\n                  );\n                })}\n              </div>\n            )}\n          </Card>\n\n          {/* RIGHT: Chat Window (spans 2 columns) */}\n          <Card className=\"lg:col-span-2 p-4 h-[700px] overflow-hidden\">\n            {selectedConversationId ? (\n              <ChatWindow\n                conversationId={selectedConversationId}\n                currentUserId={currentUserId}\n                currentUserName={currentUserName}\n              />\n            ) : (\n              <div className=\"h-full flex flex-col items-center justify-center text-muted-foreground\">\n                <MessageSquare className=\"w-12 h-12 mb-2 opacity-50\" />\n                <p>Select a conversation to start chatting</p>\n              </div>\n            )}\n          </Card>\n        </div>\n      </main>\n    </div>\n  );\n}
